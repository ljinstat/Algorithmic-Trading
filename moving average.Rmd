---
title: "Moving Average"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Moving average is a basic indicator to analyse price trend and momentumn. In R, packages to fix financial time series like "zoo", "xts" and "quantmod" are useful tools for traders.

## Plot Simple Moving Average

### Plot Simple Moving Average by quantmod
```{r data, echo=FALSE, warning=FALSE, message=FALSE, results="hide", fig.keep ='none'}
library("Quandl")
library("quantmod")
library("TTR")
library("zoo")
library("xts")
data <- getSymbols("AAPL")
Close <- Cl(AAPL)
high.close <- seriesHi(Close)
low.close <- seriesLo(Close)
data.aapl <- AAPL['2015-09-26::2016-09-26'] 
data.close <- Cl(data.aapl)
#barChart(data.aapl)
#candleChart(data.aapl,theme = "white")
par(mfrow = c(1,1))
chartSeries(data.aapl,theme = "white")
addSMA(n = 10)
addSMA(n = 50, col = 'blue')
addSMA(n = 100, col = 'green')
```

```{r, echo=FALSE, warning=FALSE}
addSMA(n = 100, col = 'green')
```

### Plot Simple Moving Average by Simple Plot
Two key functions of moving average are identifying trend and momentum. If a moving average is above the price, the stock is in an uptrend. In contrast, when a moving average is below the price, the stock is in downtrend. As for momentum, which refers to the rate of change on price movements, moving averages are used to represent short-term(less than 20 days), medium-term(20 to 100 days) and long-term(more than 100 days) price movements. Strong upward momentum is seen when shorter-term averages are located above longer-term averages and the two averages are diverging. Converse things in contrast.
```{r moving average by hand, echo=FALSE, warning= FALSE}
data.quandl.aapl <- Quandl("YAHOO/AAPL", start_date="2015-09-28", end_date="2016-09-26")
data.quandl.close <- data.quandl.aapl[nrow(data.quandl.aapl):1,]$Close

##Date
td <- data.quandl.aapl[nrow(data.quandl.aapl):1,]$Date

##Simple Moving Average
sma10 <- filter(data.quandl.close, rep(1/10, 10),sides = 1)
sma20 <- filter(data.quandl.close, rep(1/20, 20),sides = 1)
sma50 <- filter(data.quandl.close, rep(1/50, 50),sides = 1)
sma100 <- filter(data.quandl.close, rep(1/100, 100),sides = 1)
sma200 <- filter(data.quandl.close, rep(1/200, 200),sides = 1)

##Time series by zoo
data.quandl.close.ts <- zoo(x = data.quandl.close, order.by = td)

##Change sma to time series
s10 <- zoo(x = sma10, order.by = td)
s20 <- zoo(x = sma20, order.by = td)
s50 <- zoo(x = sma50, order.by = td)
s100 <- zoo(x = sma100, order.by = td)
s200 <- zoo(x = sma200, order.by = td)

##Plot sma
plot(data.quandl.close.ts, type = "l", main = "AAPL Moving Average from 2015-09-28 to 2015-09-26", xlab = "Date", ylab = "AAPL Price")
lines(s10, col = 2)
lines(s20, col = 3)
lines(s50, col = 6)
lines(s100, col = 4)
lines(s200, col = 5)
legend("bottomleft", c("SMA10","SMA20","SMA50","SMA100","SMA200"), col = c(2,3,6,4,5), lty = rep(1,5), pt.cex = 0.8, cex = rep(0.5,5))

```

## Exponential Moving Average Function and Plot
EMA is calculated by :
$$(close \,\, price-previous \,\,  EMA)*multiplier + current \,\,  EMA$$
$$multiplier = (2/(period \,\,  of  \,\, MA) + 1)$$
Since recent prices are responsable more in EMA, EMA is more sensitive than SMA.
```{r exponential moving average, echo = FALSE, warning= FALSE}
ema <- function(sma, close, timeperiod)
{
   multiplier <- (2/(timeperiod + 1))
   ema <- rep(0,length(sma))
   initial <- sma[timeperiod]
   
   ema[1:timeperiod-1] <- NA
   ema[timeperiod] <- initial
   
   for (i in timeperiod+1:length(sma)-1)
   {
     ema[i+1] <- (close[i] - ema[i])*multiplier + ema[i]
   }
   return(ema[1:length(sma)])
   
}

ema20 <- zoo(ema(s20, data.quandl.close.ts, 20), order.by = td)
plot(data.quandl.close.ts, type = "l", main = "AAPL Moving Average from 2015-09-28 to 2015-09-26", xlab = "Date", ylab = "AAPL Price")
lines(ema20, col = 2)
lines(s20, col = 3)
legend("bottomleft", c("SMA20","EMA20"), col = c(3,2), lty = rep(1,2), pt.cex = 0.8, cex = rep(0.5,2))
```

### Ploting EMA20 by quantmod
```{r, results="hide", echo = FALSE, fig.keep ='none'}
chartSeries(data.aapl,theme = "white")

```


```{r, echo = FALSE}
addEMA()
```

## Function to Choose Long or Short Position
By using simple moving average, a function is created to indicate crossovers, that is, long or short position. They can be used to determine if prices are relatively high or low. Other indicators should be used with them.
```{r automatic indicators, echo = F}
##=======================================
##Using simple moving average to decide long or short position.
##sma1 : ts; shorter-term moving average
##sma2 : ts; longer-term moving average
##price : ts; stock prices
##=======================================
long_short <- function(sma1, sma2, price)
{ 
  for (i in c(2:length(sma1)-1))
  {##eliminate effects of NA
    if((is.na(sma1[i]) == TRUE) || (is.na(sma2[i]) == TRUE))
    {next}
    if(sma1[i] != sma2[i])
    { 
      if((sma1[i] < sma2[i]) && (sma1[i+1] > sma2[i+1]))
      {
        cat("Long position at", toString(index(sma1[i+1])), "\n", "The price is", coredata(price[i+1]), "\n")
      }
      if((sma1[i] > sma2[i]) && (sma1[i+1] < sma2[i+1]))
      {
        cat("Short position at", toString(index(sma1[i+1])), "\n", "The price is", coredata(price[i+1]), "\n")
      }
    }
    else
    {sprintf("Crossover at %s. The price is %f", index(sma1[i]), coredata(price[i]))}
  }
}

long_short(s10, s20, data.quandl.close.ts)

```

## Bollinger Bands for Simple Moving Average
Bollinger bands, which are placed two standard deviations away from a simple moving average, were invented to detect dynamic volitality. The formula is : $$Upper\,\, Bollinger\,\, Bands = moving \,\,average + 2*standard\,\, deviation$$
$$Lower\,\, Bollinger\,\, Bands = moving\,\, average - 2*standard\,\, deviation$$
$$Middle\,\, Bollinger\,\, Bands = moving\,\, average$$

```{r bollinger band, echo = F, warning=F}
bolband <- function(sma, day)
##============================
##sma : simple moving average
##day : period
##============================
{
   sd <- rollapply(sma, width = day, FUN = sd, fill = NA, align = "right")
   upperbol <- sma + 2*sd
   lowerbol <- sma - 2*sd
   return(list('upper' = upperbol, 'lower' = lowerbol))
}
bb <- bolband(s20, 20)
##plot bollinger average
plot(data.quandl.close.ts, type = "l", main = "AAPL Moving Average from 2015-09-28 to 2015-09-26", xlab = "Date", ylab = "AAPL Price")
lines(s20, col = 3)
lines(bb$upper, col = 2)
lines(bb$lower, col = 2)
legend("topright", c("SMA20","Bollinger Bands"), col = c(3,2), lty = rep(1,2), pt.cex = 0.8, cex = rep(0.5,2))
```

### Ploting Bollinger Bands by quantmod
```{r,echo = F, results="hide", warning=F, fig.keep ='none'}
chartSeries(data.aapl,theme = "white")
```


```{r, echo = F, warning=F}

addBBands()
```

## Function and Plot of MACD(Moving Average Convergence and Divergence)
MACD is calculated by substracting 26-day EMA from 12-day EMA. Signal is 9-day EMA of the MACD. The MACD oscillates above and below the zero line, which is also known as the centerline. These crossovers signal that the 12-day EMA has crossed the 26-day EMA. Positive MACD means that the momentum is upward.  A bullish crossover occurs when the MACD turns up and crosses above the signal line. 
```{r MACD, echo=FALSE, warning=F}
macd <- function(s12, s26, close)
{
  ema12 <- ema(s12, close, 12)
  ema26 <- ema(s26, close, 26)
  macd <- ema12-ema26
  return(macd)
}
##sam12 and 26
sma9 <- filter(data.quandl.close, rep(1/9, 9),sides = 1)
sma12 <- filter(data.quandl.close, rep(1/12, 12),sides = 1)
sma26 <- filter(data.quandl.close, rep(1/26, 26),sides = 1)

s9 <- zoo(x = sma9, order.by = td)
s12 <- zoo(x = sma12, order.by = td)
s26 <- zoo(x = sma26, order.by = td)
##MACD
macd <- macd(s12, s26, data.quandl.close.ts)
##Signal 9-day EMA of the MACD
timeperiod <- 26
multiplier <- (2/(9 + 1))
ema9.macd <- rep(0,length(s9))
initial <- s9[26]
   
ema9.macd[1:timeperiod-1] <- NA
ema9.macd[timeperiod] <- initial
   
   for (i in timeperiod+1:length(s9)-1)
   {
     ema9.macd[i+1] <- (macd[i] - ema9.macd[i])*multiplier + ema9.macd[i]
   }
##Plot
plot(macd, type = "l", main = "AAPL Moving Average Convergence Divergence from 2015-09-28 to 2015-09-26", xlab = "Date", ylab = "MACD", col = 2)
abline(h=0, col = "green")
lines(ema9.macd, col = 4)
legend("bottomleft", c("MACD","Signal"), col = c(2,4), lty = rep(1,2), pt.cex = 0.8, cex = rep(0.5,2))
```

### Plot MACD by quantmod
```{r, echo=F, results="hide", warning=F, fig.keep ='none'}
chartSeries(data.aapl, theme = "white")

```

```{r macd, echo = F, warning=F}
addMACD()

```

